language: generic

sudo: false

matrix:
  include:
    # debug+ memory sanitizer build
    - os: linux
      compiler: clang
      env: CLANG_VERSION='3.9.1' BUILDTYPE=Debug CC="clang-3.9" CXX="clang++-3.9" CXXFLAGS="-fsanitize=memory -fno-sanitize-recover=all" CFLAGS="-fsanitize=memory -fno-sanitize-recover=all" LDFLAGS="-fsanitize=thread"
      addons:
        apt:
          sources: ['ubuntu-toolchain-r-test' ]
          packages: [ 'libstdc++-5-dev' ]
    # debug+ thread sanitizer build
    - os: linux
      compiler: clang
      env: CLANG_VERSION='3.9.1' BUILDTYPE=Debug CC="clang-3.9" CXX="clang++-3.9" CXXFLAGS="-fsanitize=thread -fno-sanitize-recover=all" CFLAGS="-fsanitize=thread -fno-sanitize-recover=all" LDFLAGS="-fsanitize=thread"
      addons:
        apt:
          sources: ['ubuntu-toolchain-r-test' ]
          packages: [ 'libstdc++-5-dev' ]
    # debug+ address,undefined sanitizer build
    - os: linux
      compiler: clang
      env: CLANG_VERSION='3.9.1' BUILDTYPE=Debug ASAN_OPTIONS=detect_leaks=1:abort_on_error=1:check_initialization_order=1:detect_stack_use_after_return=1 CC="clang-3.9" CXX="clang++-3.9" CXXFLAGS="-fsanitize=address,undefined -fsanitize-address-use-after-scope -fno-sanitize-recover=all" CFLAGS="-fsanitize=address,undefined -fno-sanitize-recover=all" LDFLAGS="-fsanitize=address,undefined"
      addons:
        apt:
          sources: ['ubuntu-toolchain-r-test' ]
          packages: [ 'libstdc++-5-dev' ]
    # coverage+debug build
    - os: linux
      compiler: clang
      env: CLANG_VERSION='3.9.1' BUILDTYPE=Debug CC="clang-3.9" CXX="clang++-3.9" CXXFLAGS="--coverage" CFLAGS="--coverage" LDFLAGS="--coverage"
      addons:
        apt:
          sources: ['ubuntu-toolchain-r-test' ]
          packages: [ 'libstdc++-5-dev' ]
    # release+linux+g++-4.9
    - os: linux
      compiler: gcc
      env: BUILDTYPE=Release CC="gcc-4.9" CXX="g++-4.9"
      addons:
        apt:
          sources: ['ubuntu-toolchain-r-test']
          packages: [ 'g++-4.9' ]
    # release+linux+g++-6
    - os: linux
      compiler: gcc
      env: BUILDTYPE=Release CC="gcc-6" CXX="g++-6"
      addons:
        apt:
          sources: ['ubuntu-toolchain-r-test']
          packages: [ 'g++-6' ]
    # release+linux+clang++
    - os: linux
      compiler: clang
      env: CLANG_VERSION='3.9.1' BUILDTYPE=Release CC="clang-3.9" CXX="clang++-3.9"
      addons:
        apt:
          sources: ['ubuntu-toolchain-r-test' ]
          packages: [ 'libstdc++-5-dev' ]
    # release+osx
    - os: osx
      compiler: clang
      env: BUILDTYPE=Release
    # debug+osx
    - os: osx
      compiler: clang
      env: BUILDTYPE=Debug

before_install:
  - DEPS_DIR="${TRAVIS_BUILD_DIR}/deps"
  - export PATH=${DEPS_DIR}/bin:${PATH} && mkdir -p ${DEPS_DIR}
  - |
    if [[ ${CLANG_VERSION:-false} != false ]]; then
      export CCOMPILER='clang'
      export CXXCOMPILER='clang++'
      CLANG_URL="https://mason-binaries.s3.amazonaws.com/${TRAVIS_OS_NAME}-x86_64/clang++/${CLANG_VERSION}.tar.gz"
      travis_retry wget --quiet -O - ${CLANG_URL} | tar --strip-components=1 -xz -C ${DEPS_DIR}
    fi

install:
 - BUILDTYPE=${BUILDTYPE} make -j4

script:
 - BUILDTYPE=${BUILDTYPE} make test
 # TODO: this looks busted (since we don't install llvm-cov)
 - if [ -n "${COVERAGE}" ]; then
       /usr/bin/llvm-cov-3.5 -lp *.o;
       pip install --user cpp-coveralls;
       ~/.local/bin/coveralls --no-gcov -i ./ --exclude clipper;
   fi
